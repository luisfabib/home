<section id="publications" class="publications">
  <div class="container">
    <div class="section-header" pAnimateOnScroll enterClass="fadeinup" duration="1000">
      <h2 class="section-title">Publications</h2>
      <p class="section-subtitle">Research contributions and academic work over the years</p>
    </div>

    <!-- Publications List -->
    <div class="publications-content">
      <!-- Publication Statistics -->
      <div class="publication-stats" pAnimateOnScroll enterClass="fadeinup" duration="1000">
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-number">{{ publicationsData.length }}</div>
            <div class="stat-label">Total Publications</div>
          </div>
          <div class="stat-item">
            <div id="total-citations" class="stat-number">{{ totalCitations }}</div>
            <div class="stat-label">Total Citations</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ uniqueYears }}</div>
            <div class="stat-label">Years Active</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">{{ journalArticlesCount }}</div>
            <div class="stat-label">Journal Articles</div>
          </div>
        </div>
      </div>
      <!-- Pagination -->
      <div class="pagination-wrapper" pAnimateOnScroll enterClass="fadeinup" duration="1000">
          <div style="display: flex; align-items: center; gap: .5rem; margin-right: 1rem;">
            <p-toggleswitch [(ngModel)]="filterFirstAuthor" (ngModelChange)="publications.set(sortedPublications($event))" />
            <span class="filter-label">Limit to First Author Publications</span>
          </div>

        <p-paginator 
          [first]="first" 
          [rows]="rows" 
          [totalRecords]="publications().length"
          [rowsPerPageOptions]="[3, 6, 9, 12]"
          (onPageChange)="onPageChange($event)"
          styleClass="custom-paginator">
        </p-paginator>
      </div>
      <div class="publications-list">
        @for (publication of paginatedPublications; track publication.id) {
          <div class="publication-item" pAnimateOnScroll enterClass="fadeinup" duration="1000">
            <p-card>
              <div class="publication-card">
                <!-- Thumbnail -->
                <div class="publication-thumbnail">
                  @if (publication.thumbnail) {
                    <img [src]="publication.thumbnail" alt="Thumbnail" class="thumbnail-img" />
                  } @else {
                    <div class="thumbnail-placeholder">
                      <i class="pi pi-file-pdf" style="font-size: 2rem; color: #64748b;"></i>
                    </div>
                  }
                </div>

                <!-- Content -->
                <div class="publication-content">
                  <div class="publication-header">
                  <p-tag 
                    [value]="getTypeLabel(publication.type)" 
                    [severity]="getTypeSeverity(publication.type)"
                    class="publication-type">
                  </p-tag>

                    <h3 class="publication-title">{{ publication.title }}</h3>
                    
                    <div class="publication-meta">
                      <div class="authors">
                        @for (author of publication.authors; track author; let last = $last) {
                          @if (author.includes('Luis')) {
                            <strong>{{ author }}</strong>
                          } @else {
                            {{ author }}}@if(!last){, }
                        }
                      </div>
                      <div class="journal-info">
                        <strong>{{ publication.journal }}</strong> • {{ publication.year }}
                      </div>
                      @if (publication.doi) {
                        @let citationCount = publication | citations;
                        @if (citationCount) {
                          <div class="citations">
                            <i class="pi pi-bookmark"></i>
                            {{ citationCount }} citations
                          </div>
                        }
                      }
                    </div>
                  </div>

                  <div class="publication-abstract">
                    <p>
                      {{ publication.abstract.substring(0, 200) }}...
                      <p-button 
                        label="Read Full Abstract" 
                        size="small"
                        [text]="true"
                        (click)="openAbstract(publication)">
                      </p-button>
                    </p>
                  </div>

                  <div class="publication-keywords">
                    @for (keyword of publication.keywords; track keyword) {
                      <p-chip [label]="keyword" class="keyword-chip"></p-chip>
                    }
                  </div>

                  <div class="publication-actions">
                    @if (publication.doi) {
                      <p-button 
                        label="DOI" 
                        icon="pi pi-external-link" 
                        size="small"
                        severity="secondary"
                        [outlined]="true"
                        (click)="openUrl('https://doi.org/' + publication.doi)">
                      </p-button>
                    }
                    @if (publication.publicationUrl) {
                      <p-button 
                        label="View Publication" 
                        icon="pi pi-eye" 
                        size="small"
                        (click)="openUrl(publication.publicationUrl)">
                      </p-button>
                    }
                    @if (publication.pdfUrl) {
                      <p-button 
                        label="Download PDF" 
                        icon="pi pi-download" 
                        size="small"
                        severity="success"
                        [outlined]="true"
                        (click)="openUrl(publication.pdfUrl)">
                      </p-button>
                    }
                  </div>
                </div>
              </div>
            </p-card>
          </div>
        }
      </div>


    </div>
  </div>

  <!-- Abstract Dialog -->
  <p-dialog 
    [(visible)]="displayAbstractDialog" 
    [modal]="true" 
    [responsive]="true" 
    [style]="{width: '80vw', maxWidth: '800px'}"
    [draggable]="false"
    [resizable]="false"
    styleClass="abstract-dialog">
    
    <ng-template pTemplate="header">
      <div class="dialog-header">
        <h3>{{ selectedPublication?.title }}</h3>
        <p class="dialog-meta">
          {{ selectedPublication?.journal }} • {{ selectedPublication?.year }}
        </p>
        @if (selectedPublication && selectedPublication.doi) {
          @let citationCount = selectedPublication | citations;
          <small>
            <strong>Citations:</strong> 
            @if (citationCount!=undefined && citationCount >= 0) {
              {{ citationCount }}
            } @else {
              <span>Loading...</span>
            }
          </small>
        }
          @if (selectedPublication && selectedPublication.doi) {
            <br>
            <small >
              <strong>DOI:</strong> 
              <a [href]="'https://doi.org/' + selectedPublication.doi" target="_blank">
                {{ selectedPublication.doi }}
              </a>
            </small>
          }
      </div>
    </ng-template>

    @if (selectedPublication) {
      <div class="dialog-content">

        <div class="abstract-section">
          <h4>Authors</h4>
          <div class="meta-row">
            {{ selectedPublication.authors.join(', ') }}
          </div>
        </div>
        <div class="abstract-section">
          <h4>Abstract</h4>
          <p-scrollPanel [style]="{width: '100%', height: '300px'}">
            <p class="abstract-text">{{ selectedPublication.abstract }}</p>
          </p-scrollPanel>
        </div>

        <div class="graphical-abstract-section" *ngIf="selectedPublication.graphicalAbstract">
          <img [src]="selectedPublication.graphicalAbstract" alt="Graphical Abstract" class="graphical-abstract-img" />
        </div>

        <div class="keywords-section">
          <div class="keywords-list">
            @for (keyword of selectedPublication.keywords; track keyword) {
              <p-chip [label]="keyword" class="dialog-keyword-chip"></p-chip>
            }
          </div>
        </div>
      </div>
    }

    <ng-template pTemplate="footer">
      <div class="dialog-actions">
        @if (selectedPublication?.publicationUrl) {
          <p-button 
            label="View Publication" 
            icon="pi pi-external-link" 
            (click)="openUrl(selectedPublication?.publicationUrl)">
          </p-button>
        }
        @if (selectedPublication?.pdfUrl) {
          <p-button 
            label="Download PDF" 
            icon="pi pi-download" 
            severity="success"
            [outlined]="true"
            (click)="openUrl(selectedPublication?.pdfUrl)">
          </p-button>
        }
        <p-button 
          label="Close" 
          severity="secondary"
          [outlined]="true"
          (click)="displayAbstractDialog = false">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
</section>
